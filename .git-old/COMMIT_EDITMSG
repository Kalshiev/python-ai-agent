Implement write_file function with directory validation and error handling
